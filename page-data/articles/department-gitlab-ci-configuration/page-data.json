{"componentChunkName":"component---src-templates-article-page-template-tsx","path":"/articles/department-gitlab-ci-configuration","result":{"pageContext":{"id":"department-gitlab-ci-configuration","lang":"cn","htmlAst":{"type":"root","children":[{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"动机"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"因为"},{"type":"element","tagName":"del","properties":{},"children":[{"type":"text","value":"作业要求"}]},{"type":"text","value":"想尝试持续集成的效果，又因为很多开源CI平台不支持自建平台（例如Travis CI），院的GitLab也不开放Shared Runner，所以只能手动配置Runner。在整个配置的过程中，遇到了很多让人很无语的坑。在这里记下来，以让大家参考。同时也记下来折腾的过程。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"先放一张效果图。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 866px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 29.122807017543863%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1klEQVQY042PS07EMAyGc2xOwAlG4gQs5iDskVjMIKF5qFVF83Li5p1pB6dQViz4lDhfLHvxM0xeB2viFFJ2MceU40pKaavt5JzaQMghl9sGGyZxgr7DT46+U04ACs7HkWutpRR6hXMuhRwUXrgdjau1fMOcd8FHh8E7T3ee5/tfLMvy6/MKddjxcHy/HN7Or9f+2vVDrfX+b9j+ef/08rj7eOimE/1LLZSzbGTKmijwj+fVqEfSliWhpAJFrzEWcVKq5QTQ1lrQYKwhyBERoBmi9d7T8hdcmFZQwmZdqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"buildsuccess","title":"buildsuccess","src":"/static/42469d00c92c6793ef7869d80da60291/ecf7e/buildsuccess.png","srcSet":["/static/42469d00c92c6793ef7869d80da60291/5459c/buildsuccess.png 285w","/static/42469d00c92c6793ef7869d80da60291/2cee3/buildsuccess.png 570w","/static/42469d00c92c6793ef7869d80da60291/ecf7e/buildsuccess.png 866w"],"sizes":["(max-width:","866px)","100vw,","866px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"项目地址：\n"},{"type":"element","tagName":"a","properties":{"href":"http://101.37.19.32:10080/161250010/gitlabcitest"},"children":[{"type":"text","value":"http://101.37.19.32:10080/161250010/gitlabcitest"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"GitLab版本过老，需要使用老版本的runner"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"院的GitLab版本是"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1140px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 6.315789473684211%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAASElEQVQI1wE9AML/APv7+9jY2Nzc3ODg4OHh4dvb29zc3Nvb29/f39nZ2dzc3OLi4t7e3+Xl5e3t7fH19fC8weuOmeyVnu+nr0CIMzhn6bIaAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"gitlabversion","title":"gitlabversion","src":"/static/576ddb0087da47ea4f57e6fad0949068/267c0/gitlabversion.png","srcSet":["/static/576ddb0087da47ea4f57e6fad0949068/5459c/gitlabversion.png 285w","/static/576ddb0087da47ea4f57e6fad0949068/2cee3/gitlabversion.png 570w","/static/576ddb0087da47ea4f57e6fad0949068/267c0/gitlabversion.png 1140w","/static/576ddb0087da47ea4f57e6fad0949068/4cc5e/gitlabversion.png 1475w"],"sizes":["(max-width:","1140px)","100vw,","1140px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"。截止当前（2017/11/6）GitLab CE已经更新到了大版本10，这个8.10版本官方早就已经放弃治疗，甚至在gitlab-runner的"},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/runner/index.html#compatibility-chart"},"children":[{"type":"text","value":"兼容性页面"}]},{"type":"text","value":"上都找不到这个版本的信息。"},{"type":"element","tagName":"del","properties":{},"children":[{"type":"text","value":"看来你院使用过时技术的传统看来还要继续延续多年。"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"所以现在在官网的"},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/runner/install/linux-repository.html"},"children":[{"type":"text","value":"GitLab Runner安装教程"}]},{"type":"text","value":"已经不适合。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"如果使用新版本的gitlab runner运行的话，会提示"},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"405（Method Not Allowed）"}]},{"type":"text","value":"错误。这是由于新版本的Runner会使用GitLab从9.0开始换用的新的GitLab API v4，而8.x版本仍然使用老版本的API。这就造成了错误。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"同时，Runner从10版本从"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"gitlab-ci-multi-runner"}]},{"type":"text","value":"更名为"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"gitlab-runner"}]},{"type":"text","value":"，但是配置方法大致一样。配置可以参考这个"},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/runner/register/index.html"},"children":[{"type":"text","value":"链接"}]},{"type":"text","value":"。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"GitLab正确的安装和配置方法方法如下（以Ubuntu 16.04 x64通过apt-get举例）："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"根据"},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/runner/install/old.html"},"children":[{"type":"text","value":"这个"}]},{"type":"text","value":"设置老版本的apt源;"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"运行安装命令："},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"sudo apt-get install gitlab-ci-multi-runner=1.9.5"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"配置时使用命令："},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"sudo gitlab-ci-multi-runner register"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"配置好了后，runner页面应该能看到提示的可用的runner。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Ubuntu官方源Node版本太低"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"配置好了runner，我首先使用了我的博客前端的程序用来做测试。为了简化，使用了shell executor。这就需要配置runner机器的环境。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"先写一份"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".gitlab-ci.yml"}]},{"type":"text","value":"文件。我使用的文件如下："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"stages"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" build\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"buildjob"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"stage"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" build\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"script"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" npm install\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" python cleanup.py\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" set NODE_ENV=production\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" webpack "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"p "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"color\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"cache"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"paths"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" ./node_modules/"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"直接敲"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"sudo apt-get install nodejs"}]},{"type":"text","value":"，然后就开始build。结果在build的时候才发现node版本很低……"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1140px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 32.280701754385966%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAABA0lEQVQY02P4/e/fn/8o4O+fv/+JAP/+/WNYtHhJbHxiVnZuYnJqUkpqckpabHxCHAglQlFCIoINRgmJycEhYYsXL2EorywXkxTR0FKXlpMRk5QWhyERMQkBIVFBYSQkIgZBohKSDCxsZRWVDI3N9Upq8kamBnoGumoaWqrqmmCkoaKmAWQASWUVNWVVdSBSVFYBIgUlFSAbaFZ9QxNDQ1OzoqqaibmlgZEJEOnp6+sAjdE31DMAIiNdAyN1TW0lFTVFZVV5RWU5RSVpWXkZOQVObt7q2jqGtvZOoJyJmYWBkTFQs76hERiB2AaGxmCGsa6egbauvg4M6RsYycoptrV3AACwHH6N+SpiFgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"lownodeversion","title":"lownodeversion","src":"/static/ca0d69fcfc7379e9af7bf486c311db7b/267c0/lownodeversion.png","srcSet":["/static/ca0d69fcfc7379e9af7bf486c311db7b/5459c/lownodeversion.png 285w","/static/ca0d69fcfc7379e9af7bf486c311db7b/2cee3/lownodeversion.png 570w","/static/ca0d69fcfc7379e9af7bf486c311db7b/267c0/lownodeversion.png 1140w","/static/ca0d69fcfc7379e9af7bf486c311db7b/78a90/lownodeversion.png 1710w","/static/ca0d69fcfc7379e9af7bf486c311db7b/bdf18/lownodeversion.png 1948w"],"sizes":["(max-width:","1140px)","100vw,","1140px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"只能自己设置apt源了。Node官方提供的源说明"},{"type":"element","tagName":"a","properties":{"href":"https://nodejs.org/en/download/package-manager/"},"children":[{"type":"text","value":"参照这个链接"}]},{"type":"text","value":"。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"构建时内存提示不足"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"上传后，pipeline自动开始build。然而虽然想到了Node非常耗费内存，但是没想到512M内存都不够吃……跑"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"npm install"}]},{"type":"text","value":"的时候被bash无情杀掉。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1140px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 7.017543859649122%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAMklEQVQI12OwsLDQ0dXR0tbR1NJWUlEDInUNdRVVdUVlFTBSBSKgoIISiAsmVYEkBAEAG4cIyAv/abEAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"notenoughmem","title":"notenoughmem","src":"/static/0fd6d55d36e75cf880efdc7b49bfa97f/267c0/notenoughmem.png","srcSet":["/static/0fd6d55d36e75cf880efdc7b49bfa97f/5459c/notenoughmem.png 285w","/static/0fd6d55d36e75cf880efdc7b49bfa97f/2cee3/notenoughmem.png 570w","/static/0fd6d55d36e75cf880efdc7b49bfa97f/267c0/notenoughmem.png 1140w","/static/0fd6d55d36e75cf880efdc7b49bfa97f/6de9d/notenoughmem.png 1576w"],"sizes":["(max-width:","1140px)","100vw,","1140px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"后来把内存加到2G才够npm install使用。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"为了简化工程，后来使用了"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/mobxjs/mobx-react-typescript-boilerplate.git"},"children":[{"type":"text","value":"Mobx官方提供的boilderplate项目"}]},{"type":"text","value":"作为测试。这也就是现在的项目。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"你正在成功！"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"成功了！折腾了这些后，终于成功build了一次。\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1140px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 28.421052631578945%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxklEQVQY021R0Q6DIAzk/79vr3vak1tgujG1hfZGIRh1a3IR0nJ3PR0RY1kWMDPWda3flBJUFSKCXCAnWK/3z3DEGZJzvRiRkdoZUPTqBAarPnvuGRwl3p6qCqg4bGrAi2bc3sPhoVUuBvZb7IXd8Ang3NRoJdyHB3wIhVgwxAkXf/0hTJKQi7jFE2OskZmIlZsolpzahUue3oc6NFMCJ/27ss2LtrVtlog2p84v04FwfI5VTUTbD9HjSs1hrg5tztxZ7t3hFywO2L/ojQdJAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"buildstatus","title":"buildstatus","src":"/static/38bc1cd7b07d6ebaf8bd0ed65523b64b/267c0/buildstatus.png","srcSet":["/static/38bc1cd7b07d6ebaf8bd0ed65523b64b/5459c/buildstatus.png 285w","/static/38bc1cd7b07d6ebaf8bd0ed65523b64b/2cee3/buildstatus.png 570w","/static/38bc1cd7b07d6ebaf8bd0ed65523b64b/267c0/buildstatus.png 1140w","/static/38bc1cd7b07d6ebaf8bd0ed65523b64b/fc617/buildstatus.png 1431w"],"sizes":["(max-width:","1140px)","100vw,","1140px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"还给README.md加上了badge（题图）"},{"type":"element","tagName":"a","properties":{"href":"https://docs.gitlab.com/ee/ci/pipelines.html#badges"},"children":[{"type":"text","value":"(教程)"}]},{"type":"text","value":"，这样看上去就非常像是一个非常好的开源项目。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"结语"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"GitLab CI确实是非常好用的工具，它能和GitLab无缝集成，而且非常的简单易用（这些坑都不是GitLab的）。这几天我会把整个软工2项目的CI环境搭建好，需要学习控制台下gradle相关命令以及Linux下的一些配置，这样真正开始开发的时候才能更高效。"}]}],"data":{"quirksMode":false}},"headings":[{"depth":1,"value":"动机","slug":"动机"},{"depth":2,"value":"GitLab版本过老，需要使用老版本的runner","slug":"gitlab版本过老，需要使用老版本的runner"},{"depth":1,"value":"Ubuntu官方源Node版本太低","slug":"ubuntu官方源node版本太低"},{"depth":1,"value":"构建时内存提示不足","slug":"构建时内存提示不足"},{"depth":1,"value":"你正在成功！","slug":"你正在成功！"},{"depth":1,"value":"结语","slug":"结语"}]}},"staticQueryHashes":["3830103294"]}